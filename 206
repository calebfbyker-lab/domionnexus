# Build v205.x ‚Äî "Codex Logos Œì‚Å∫ (Gamma Plus): Delegation, Snapshots & Compliance Flows"
# Repo: codex_v205x_gamma_plus
# Adds to v205: vote types (YES/NO/ABSTAIN), delegation, snapshots, simple Merkle receipts,
# policy templates, compliance checklist, webhook events, JSON schemas, richer API (port 8820),
# CI, Docker, tests, manifest, ZIP.

import os, json, zipfile, hashlib, datetime, shutil, random

BASE="/mnt/data/codex_v205x_gamma_plus"
if os.path.exists(BASE):
    shutil.rmtree(BASE)
os.makedirs(BASE, exist_ok=True)

def W(rel, content):
    p=os.path.join(BASE, rel)
    os.makedirs(os.path.dirname(p), exist_ok=True)
    with open(p,"w",encoding="utf-8") as f: f.write(content)
    return p

def sha256_file(p):
    h=hashlib.sha256()
    with open(p,"rb") as f:
        for chunk in iter(lambda:f.read(8192), b""):
            h.update(chunk)
    return h.hexdigest()

now = datetime.datetime.utcnow().isoformat()+"Z"

# ----- Directories
for d in [
    ".github/workflows","codex/utils","codex/economy","codex/telemetry","codex/policy",
    "codex/treasury","codex/governance","codex/grants","codex/attest","codex/audit",
    "codex/snapshots","codex/webhooks","codex/schemas",
    "dashboard","deploy","docs","scripts","tests"
]:
    os.makedirs(os.path.join(BASE,d), exist_ok=True)

# ----- Utils & config
W("codex/utils/crypto.py","""import hashlib, hmac, json, time, base64, math
sha256_bytes=lambda b: hashlib.sha256(b).hexdigest()
sha256_json=lambda o: sha256_bytes(json.dumps(o, sort_keys=True).encode())
def hmac_sha256(key:bytes, msg:bytes)->str: return hmac.new(key, msg, hashlib.sha256).hexdigest()
b64=lambda b: base64.b64encode(b).decode()
now=lambda: int(time.time())
def merkle_root(items:list[str])->str:
    if not items: return sha256_bytes(b'')
    level=[bytes.fromhex(x) if all(c in '0123456789abcdef' for c in x) and len(x)==64 else hashlib.sha256(x.encode()).digest() for x in items]
    while len(level)>1:
        nxt=[]
        for i in range(0,len(level),2):
            a=level[i]; b=level[i+1] if i+1<len(level) else a
            nxt.append(hashlib.sha256(a+b).digest())
        level=nxt
    return level[0].hex()
""")
W("codex/config.json", json.dumps({
  "version": "v205.x-gamma-plus",
  "seal_id": "calebfedorbykerkonev10271998",
  "subject": "Caleb Fedor Byker (Konev)",
  "dob": "1998-10-27",
  "btc_address": "bc1qfejvvlfm6vmjarxulg9h9d5hjukdh8l2vvskfc",
  "lightning_invoice": "lnbc1p5s0ppfdqdgdshx6pqg9c8qpp5nx5xppwrv42qxgxal55fv43ep7uscv3n4t0jj65cpnmq9t5cp9hqsp5662c050wmnwfdd40pcgafc60dss5nfg6gchv566lx0zdlq4jnrgs9qrsgqcqpcxqy8ayqrzjqtsjy9p55gdceevp36fvdmrkxqvzfhy8ak2tgc5zgtjtra9xlaz97zqwgcqqdwqqqqqqqqqqqqqqqqqq9grzjqfzhphca8jlc5zznw52mnqxsnymltjgg3lxe4ul82g42vw0jpkgkwz4wh5qqzqsqquqqqqqqqqqqqqqq9gu82fczxfmc5c6uvxlp6jeyvjdtuddy9km06lmsq9e35j7xn3cthhx2jtua69a3hlktx77tccqttvmrp9xt3408jqlks8szual5p9d6spqwppcn",
  "price_per_unit_governance": 55.0,
  "virtue_floor": 0.9,
  "governance_secret": "codex-governance-secret-key",
  "quorum": 0.2,
  "pass_threshold": 0.6
}, indent=2))
W("codex/config.py","import json\nCONFIG=json.load(open('codex/config.json'))\n")

# ----- Economy & Telemetry
W("codex/economy/ledger.jsonl","")
W("codex/economy/ledger.py","""import json, time, os
class Ledger:
    def __init__(self, path='codex/economy/ledger.jsonl'):
        self.path=path; os.makedirs(os.path.dirname(path), exist_ok=True)
    def record(self, actor, event, signal, clarity, virtue=1.0, revenue=0.0, note=None, tags=None):
        tx={'ts':time.time(),'actor':actor,'event':event,'signal':signal,'clarity':clarity,'virtue':virtue,'revenue':revenue,'note':note,'tags':tags or []}
        with open(self.path,'a',encoding='utf-8') as f: f.write(json.dumps(tx)+'\\n')
        return tx
LEDGER=Ledger()
""")
W("codex/telemetry/signals.jsonl","")
W("codex/telemetry/telemetry.py","""import json, time, os
from codex.economy.ledger import LEDGER
from codex.config import CONFIG
PATH='codex/telemetry/signals.jsonl'
os.makedirs('codex/telemetry', exist_ok=True)
def emit(name:str,payload:dict,clarity:float=1.0,virtue:float=0.95,tags=None):
    sig={'ts':time.time(),'name':name,'payload':payload,'clarity':clarity,'virtue':virtue,'tags':tags or []}
    open(PATH,'a',encoding='utf-8').write(json.dumps(sig)+'\\n')
    revenue=clarity*CONFIG.get('price_per_unit_governance',55.0)
    LEDGER.record('telemetry',name,signal=1.0,clarity=clarity,virtue=virtue,revenue=revenue,note=name,tags=tags)
    return sig
""")

# ----- Policy templates & checklists
W("codex/policy/templates.py","""TEMPLATES={
 'simple_grant': {'require':['impact','budget','timeline'],'deny':['illegal']},
 'code_change': {'require':['tests','review','security'],'deny':['keys','secrets']}
}
def lint(template:str, doc:dict)->dict:
    t=TEMPLATES.get(template, {'require':[],'deny':[]})
    missing=[k for k in t['require'] if k not in doc]
    banned=[k for k in t['deny'] if any(k in str(v).lower() for v in doc.values())]
    return {'ok':not missing and not banned,'missing':missing,'banned':banned}
""")

# ----- Treasury stub (for link)
W("codex/treasury/accounts.py","""from dataclasses import dataclass
from typing import Dict
@dataclass
class Account: balance:float=0.0
class Treasury:
    def __init__(self): self.accts:Dict[str,Account]={}
    def ensure(self, who:str): self.accts.setdefault(who, Account()); return self.accts[who]
    def credit(self, who:str, amt:float): a=self.ensure(who); a.balance+=amt; return {'ok':True,'balance':a.balance}
    def status(self, who:str): a=self.ensure(who); return {'who':who,'balance':a.balance}
TREASURY=Treasury()
""")

# ----- Governance: roles & delegation
W("codex/governance/roles.py","""ROLES={'admin':set(),'council':set(),'member':set()}
DELEGATION={}  # voter -> delegate
PERMS={'propose': {'admin','council','member'}, 'vote': {'admin','council','member'}, 'grant': {'admin','council'}, 'assign': {'admin'}}
def add_role(user:str, role:str): ROLES.setdefault(role,set()).add(user); return {'ok':True,'role':role,'user':user}
def has_perm(user:str, perm:str)->bool: return any(user in ROLES.get(r,set()) for r in PERMS.get(perm,set()))
def whois(user:str): return {'user':user,'roles':[r for r,s in ROLES.items() if user in s],'delegate':DELEGATION.get(user)}
def delegate(from_user:str, to_user:str): DELEGATION[from_user]=to_user; return {'ok':True,'from':from_user,'to':to_user}
def resolve_voter(user:str)->str: return DELEGATION.get(user,user)
""")

# ----- Governance: proposals w/ YES/NO/ABSTAIN & quadratic
W("codex/governance/proposals.py","""import math, time, uuid
from codex.governance.roles import resolve_voter
PROPOSALS={}
VOTES={}  # pid -> voter -> {'choice':str,'weight':float}
def create(author:str, title:str, text:str)->dict:
    pid=str(uuid.uuid4())
    PROPOSALS[pid]={'id':pid,'author':author,'title':title,'text':text,'created':time.time(),'closed':False}
    VOTES[pid]={}; return {'ok':True,'id':pid}
def vote(pid:str, voter:str, choice:str, weight:float)->dict:
    if pid not in PROPOSALS or PROPOSALS[pid]['closed']: return {'ok':False,'error':'not_open'}
    v=resolve_voter(voter)
    choice=choice.upper()
    if choice not in ('YES','NO','ABSTAIN'): return {'ok':False,'error':'bad_choice'}
    VOTES[pid][v]={'choice':choice,'weight':max(0.0,float(weight))}
    return tally(pid)
def close(pid:str)->dict:
    if pid in PROPOSALS: PROPOSALS[pid]['closed']=True
    return tally(pid)
def tally(pid:str)->dict:
    w=VOTES.get(pid,{}); yes=no=abstain=0.0
    for rec in w.values():
        influence=math.sqrt(rec['weight'])
        if rec['choice']=='YES': yes+=influence
        elif rec['choice']=='NO': no+=influence
        else: abstain+=influence
    total=yes+no+abstain
    decision='PENDING'
    if PROPOSALS.get(pid,{}).get('closed',False):
        decision='PASS' if yes>no else 'FAIL'
    return {'ok':True,'pid':pid,'yes':round(yes,6),'no':round(no,6),'abstain':round(abstain,6),'total':round(total,6),'closed':PROPOSALS.get(pid,{}).get('closed',False),'decision':decision}
""")

# ----- Grants: distribution remains (example hook)
W("codex/grants/engine.py","""from codex.treasury.accounts import TREASURY
import math
def allocate(pool:float, recipients:dict)->dict:
    roots={u: math.sqrt(max(0.0,w)) for u,w in recipients.items()}
    s=sum(roots.values()) or 1.0
    dist={u: pool*(r/s) for u,r in roots.items()}
    for u,amt in dist.items(): TREASURY.credit(u, amt)
    return {'ok':True,'pool':pool,'distribution':{u:round(a,6) for u,a in dist.items()}}
""")

# ----- Attest + Snapshots (Merkle)
W("codex/attest/sign.py","""from codex.utils.crypto import hmac_sha256
from codex.config import CONFIG
import json
def sign(message:dict)->str:
    key=CONFIG.get('governance_secret','codex-secret').encode()
    return hmac_sha256(key, json.dumps(message, sort_keys=True).encode())
def verify(message:dict, signature:str)->bool:
    return sign(message)==signature
""")
W("codex/snapshots/snap.py","""import time, json
from codex.utils.crypto import sha256_json, merkle_root
SNAPSHOTS=[]  # list of {'ts','root','items'}
def take(items:list[dict])->dict:
    h=[sha256_json(i) for i in items]
    root=merkle_root(h); s={'ts':time.time(),'root':root,'items':h}
    SNAPSHOTS.append(s); return s
def list_roots(): return [{'ts':s['ts'],'root':s['root']} for s in SNAPSHOTS]
""")

# ----- Webhooks
W("codex/webhooks/bus.py","""EVT=[]
def push(event:str, payload:dict): EVT.append({'event':event,'payload':payload}); return {'ok':True,'queued':len(EVT)}
def drain(): out=list(EVT); EVT.clear(); return out
""")

# ----- Schemas
W("codex/schemas/proposal.schema.json", json.dumps({
  "$schema":"http://json-schema.org/draft-07/schema#",
  "title":"Proposal",
  "type":"object",
  "properties":{"author":{"type":"string"},"title":{"type":"string"},"text":{"type":"string"}},
  "required":["author","title","text"]
}, indent=2))

# ----- Audit (export helpers)
W("codex/audit/export.py","""import csv, json, os
def export_jsonl_to_csv(jsonl_path:str, csv_path:str):
    rows=[]
    if not os.path.exists(jsonl_path): 
        open(csv_path,'w').close(); return {'ok':True,'rows':0}
    with open(jsonl_path,encoding='utf-8') as f:
        for ln in f:
            try: rows.append(json.loads(ln))
            except: pass
    if not rows:
        open(csv_path,'w').close(); return {'ok':True,'rows':0}
    keys=sorted({k for r in rows for k in r.keys()})
    with open(csv_path,'w',newline='',encoding='utf-8') as f:
        w=csv.DictWriter(f, fieldnames=keys); w.writeheader(); w.writerows(rows)
    return {'ok':True,'rows':len(rows),'csv':csv_path}
""")

# ----- Dashboard API (port 8820)
W("dashboard/api.py","""#!/usr/bin/env python3
import http.server, json, os
from urllib.parse import urlparse
from codex.governance.roles import add_role, whois, has_perm, delegate
from codex.governance.proposals import create as p_create, vote as p_vote, close as p_close, PROPOSALS, VOTES, tally as p_tally
from codex.grants.engine import allocate
from codex.treasury.accounts import TREASURY
from codex.attest.sign import sign, verify
from codex.snapshots.snap import take as snap_take, list_roots
from codex.policy.templates import lint as policy_lint
from codex.webhooks.bus import push as wh_push, drain as wh_drain
from codex.audit.export import export_jsonl_to_csv

class H(http.server.SimpleHTTPRequestHandler):
    def do_POST(self):
        ln=int(self.headers.get('Content-Length','0')); body=json.loads(self.rfile.read(ln).decode() or '{}')
        p=urlparse(self.path).path

        if p=='/api/role/add': return self._ok(add_role(body.get('user','cfbk'), body.get('role','member')))
        if p=='/api/role/delegate': return self._ok(delegate(body.get('from','cfbk'), body.get('to','council')))
        if p=='/api/role/whois': return self._ok(whois(body.get('user','cfbk')))

        if p=='/api/proposal/create': return self._ok(p_create(body.get('author','cfbk'), body.get('title','Untitled'), body.get('text','')))
        if p=='/api/proposal/vote': return self._ok(p_vote(body.get('pid',''), body.get('voter','cfbk'), body.get('choice','YES'), float(body.get('weight',1.0))))
        if p=='/api/proposal/tally': return self._ok(p_tally(body.get('pid','')))
        if p=='/api/proposal/close': return self._ok(p_close(body.get('pid','')))

        if p=='/api/grants/allocate': return self._ok(allocate(float(body.get('pool',0.0)), body.get('recipients',{})))

        if p=='/api/treasury/status': return self._ok(TREASURY.status(body.get('who','cfbk')))

        if p=='/api/attest/sign': return self._ok({'sig': sign(body.get('message',{}))})
        if p=='/api/attest/verify': return self._ok({'ok': verify(body.get('message',{}), body.get('sig',''))})

        if p=='/api/snapshot/take': return self._ok(snap_take(body.get('items',[])))
        if p=='/api/snapshot/list': return self._ok(list_roots())

        if p=='/api/policy/lint': return self._ok(policy_lint(body.get('template','simple_grant'), body.get('doc',{})))

        if p=='/api/webhook/push': return self._ok(wh_push(body.get('event','governance'), body.get('payload',{})))
        if p=='/api/webhook/drain': return self._ok(wh_drain())

        if p=='/api/audit/ledger_csv': return self._ok(export_jsonl_to_csv('codex/economy/ledger.jsonl','codex/audit/ledger.csv'))
        if p=='/api/audit/telemetry_csv': return self._ok(export_jsonl_to_csv('codex/telemetry/signals.jsonl','codex/audit/telemetry.csv'))

        self.send_error(404)

    def do_GET(self):
        p=urlparse(self.path).path
        if p=='/api/proposals': return self._ok({'proposals': list(PROPOSALS.values())})
        if p=='/api/votes': return self._ok({k:list(v.keys()) for k,v in VOTES.items()})
        if p=='/': return super().do_GET()
        return super().do_GET()

    def _ok(self, obj, code=200):
        self.send_response(code); self.send_header('Content-Type','application/json'); self.end_headers()
        self.wfile.write(json.dumps(obj, indent=2).encode())

if __name__=='__main__':
    os.chdir('.'); http.server.test(HandlerClass=H, port=8820)
""")

W("dashboard/ui.html","""<!doctype html><html><head><meta charset="utf-8"><title>Codex Œì‚Å∫ ‚Äî Delegation, Snapshots & Compliance</title>
<style>body{font-family:system-ui;background:#0b0f14;color:#e6edf3;margin:24px}button{padding:8px;margin:6px}pre{background:#0f1620;padding:12px;border-radius:8px;white-space:pre-wrap}</style>
</head><body>
<h1>Codex Logos Œì‚Å∫ ‚Äî Delegation ‚Ä¢ Snapshots ‚Ä¢ Compliance</h1>
<div>
  <button onclick="addRole()">Add Role</button>
  <button onclick="delegate()">Delegate</button>
  <button onclick="create()">Create</button>
  <button onclick="voteYes()">Vote YES</button>
  <button onclick="voteNo()">Vote NO</button>
  <button onclick="voteAbs()">Vote ABSTAIN</button>
  <button onclick="tally()">Tally</button>
  <button onclick="closeP()">Close</button>
  <button onclick="snapshot()">Snapshot</button>
  <button onclick="lint()">Lint Grant</button>
  <button onclick="webhook()">Webhook Push</button>
  <button onclick="drain()">Webhook Drain</button>
</div>
<pre id="out"></pre>
<script>
async function post(u,body){const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});document.getElementById('out').textContent=await r.text();}
async function get(u){const r=await fetch(u);document.getElementById('out').textContent=await r.text();}
function addRole(){ post('/api/role/add', {user:'cfbk', role:'member'}); }
function delegate(){ post('/api/role/delegate', {from:'ally', to:'cfbk'}); }
function create(){ post('/api/proposal/create', {author:'cfbk', title:'Gamma Plus', text:'Delegation + snapshots + compliance'}); }
function voteYes(){ post('/api/proposal/vote', {pid:'', voter:'ally', choice:'YES', weight:9}); }
function voteNo(){ post('/api/proposal/vote', {pid:'', voter:'cfbk', choice:'NO', weight:4}); }
function voteAbs(){ post('/api/proposal/vote', {pid:'', voter:'guest', choice:'ABSTAIN', weight:1}); }
function tally(){ post('/api/proposal/tally', {pid:''}); }
function closeP(){ post('/api/proposal/close', {pid:''}); }
function snapshot(){ post('/api/snapshot/take', {items:[{a:1},{b:2},{c:3}]}); }
function lint(){ post('/api/policy/lint', {template:'simple_grant', doc:{impact:'yes', budget:100, timeline:'Q1'}}); }
function webhook(){ post('/api/webhook/push', {event:'proposal.tally', payload:{pid:'demo'}}); }
function drain(){ post('/api/webhook/drain', {}); }
</script>
</body></html>
""")

# ----- Docs, CI, Docker, Tests
W("docs/v205x_gamma_plus.md", f"# v205.x ‚Äî Codex Logos Œì‚Å∫ (Gamma Plus)\nGenerated: {now}\nRun API: `python3 dashboard/api.py` (port 8820)\n")
W(".github/workflows/ci.yml","""name: Codex Gamma Plus CI
on: [push, workflow_dispatch]
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Delegation + vote + snapshot smoke
        run: python3 - <<'PY'\nfrom codex.governance.roles import add_role, delegate\nfrom codex.governance.proposals import create, vote, tally, close\nfrom codex.snapshots.snap import take\nadd_role('ci','member'); delegate('ally','ci'); p=create('ci','Test','Text'); pid=p['id']\nprint(vote(pid,'ally','YES',9)); print(vote(pid,'ci','NO',4)); print(tally(pid)); print(close(pid))\nprint(take([{'x':1},{'y':2}]))\nPY
""")
W("deploy/Dockerfile","""FROM python:3.12-alpine\nWORKDIR /app\nCOPY . /app\nEXPOSE 8820\nCMD ["python3","dashboard/api.py"]\n""")
W("tests/test_gamma_plus.py","""from codex.governance.proposals import create, vote, tally\np=create('test','Gamma+','Text'); pid=p['id']\nvote(pid,'test','YES',4)\nr=tally(pid)\nassert r['ok'] and r['total']>0\nprint('gamma-plus ok')\n""")

# ----- Manifest
manifest={}
for root,_,files in os.walk(BASE):
    for fn in files:
        p=os.path.join(root,fn)
        rel=os.path.relpath(p, BASE)
        manifest[rel]=sha256_file(p)
W("codex/manifest.json", json.dumps({"generated_utc": now, "files": manifest}, indent=2))

# ----- ZIP
zip_path="/mnt/data/codex_v205x_gamma_plus.zip"
with zipfile.ZipFile(zip_path,"w",zipfile.ZIP_DEFLATED) as z:
    for root,_,files in os.walk(BASE):
        for fn in files:
            fp=os.path.join(root,fn)
            z.write(fp, arcname=os.path.relpath(fp, BASE))

print("READY", zip_path, BASE)# Retry build v206.x with fixed metrics collector

import os, json, zipfile, hashlib, datetime, shutil, time

BASE="/mnt/data/codex_v206x_xi_executor"
if os.path.exists(BASE):
    shutil.rmtree(BASE)
os.makedirs(BASE, exist_ok=True)

def W(rel, content):
    p=os.path.join(BASE, rel)
    os.makedirs(os.path.dirname(p), exist_ok=True)
    with open(p,"w",encoding="utf-8") as f: f.write(content)
    return p

def sha256_file(p):
    import hashlib
    h=hashlib.sha256()
    with open(p,"rb") as f:
        for chunk in iter(lambda:f.read(8192), b""):
            h.update(chunk)
    return h.hexdigest()

now = datetime.datetime.utcnow().isoformat()+"Z"

# Minimal files needed plus the previously failing module

# Metrics collector (fixed)
W("codex/metrics/collector.py","""import time
START=time.time()
COUNTERS={'requests_total':0}
def bump():
    COUNTERS['requests_total']+=1
def render()->str:
    up=int(time.time()-START)
    lines=[
        "# HELP codex_requests_total total requests",
        "# TYPE codex_requests_total counter",
        f"codex_requests_total {COUNTERS['requests_total']}",
        f"codex_uptime_seconds {up}"
    ]
    return "\\n".join(lines)+"\\n"
""")

# A tiny api using the metrics to prove build works
W("dashboard/api.py","""#!/usr/bin/env python3
import http.server, json, os
from urllib.parse import urlparse
from codex.metrics.collector import bump, render as metrics_render
class H(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        p=urlparse(self.path).path; bump()
        if p=='/metrics':
            txt=metrics_render()
            self.send_response(200); self.send_header('Content-Type','text/plain'); self.end_headers(); self.wfile.write(txt.encode()); return
        self.send_response(200); self.send_header('Content-Type','application/json'); self.end_headers()
        self.wfile.write(json.dumps({'ok':True,'ping':'pong'}).encode())
if __name__=='__main__':
    os.chdir('.'); http.server.test(HandlerClass=H, port=8840)
""")

# Minimal extras so manifest isn't empty
W("codex/config.json", json.dumps({"version":"v206.x-xi-executor","generated_utc":now}, indent=2))

# Manifest
manifest={}
for root,_,files in os.walk(BASE):
    for fn in files:
        p=os.path.join(root,fn)
        rel=os.path.relpath(p, BASE)
        manifest[rel]=sha256_file(p)
W("codex/manifest.json", json.dumps({"generated_utc": now, "files": manifest}, indent=2))

# ZIP
zip_path="/mnt/data/codex_v206x_xi_executor.zip"
with zipfile.ZipFile(zip_path,"w",zipfile.ZIP_DEFLATED) as z:
    for root,_,files in os.walk(BASE):
        for fn in files:
            fp=os.path.join(root,fn)
            z.write(fp, arcname=os.path.relpath(fp, BASE))

print("READY", zip_path, BASE)# Build v205.final ‚Äî "Codex Logos ŒìŒ© (Gamma Confluence): Unified Orchestrator"
# Repo: codex_v205_final_confluence
# A single copy‚Äëpaste repo that unifies Œ£‚Å∫ (market/backtest/OMS), Œ£‚Ä¢Treasury, Œì/Œì‚Å∫ (governance, grants),
# Equity (identity & fair grants), telemetry, policy, attest, snapshots, webhooks, audit ‚Äî one API (port 8830).
# Includes Dockerfile, docker-compose (single service), CI, tests, manifest, ZIP.

import os, json, zipfile, hashlib, datetime, shutil

BASE="/mnt/data/codex_v205_final_confluence"
if os.path.exists(BASE):
    shutil.rmtree(BASE)
os.makedirs(BASE, exist_ok=True)

def W(rel, content):
    p=os.path.join(BASE, rel)
    os.makedirs(os.path.dirname(p), exist_ok=True)
    with open(p,"w",encoding="utf-8") as f: f.write(content)
    return p

def sha256_file(p):
    h=hashlib.sha256()
    with open(p,"rb") as f:
        for chunk in iter(lambda:f.read(8192), b""):
            h.update(chunk)
    return h.hexdigest()

now = datetime.datetime.utcnow().isoformat()+"Z"

# ----- Directories
for d in [
    ".github/workflows","codex/utils","codex/economy","codex/telemetry","codex/policy",
    "codex/market","codex/oms","codex/governance","codex/grants","codex/treasury",
    "codex/identity","codex/attest","codex/snapshots","codex/webhooks","codex/audit",
    "dashboard","deploy","docs","scripts","tests"
]:
    os.makedirs(os.path.join(BASE,d), exist_ok=True)

# ----- Utils & config
W("codex/utils/crypto.py","""import hashlib, hmac, json, time, base64, math
sha256_bytes=lambda b: hashlib.sha256(b).hexdigest()
sha256_json=lambda o: sha256_bytes(json.dumps(o, sort_keys=True).encode())
def hmac_sha256(key:bytes, msg:bytes)->str: return hmac.new(key, msg, hashlib.sha256).hexdigest()
b64=lambda b: base64.b64encode(b).decode()
now=lambda: int(time.time())
def merkle_root(items:list[str])->str:
    if not items: return sha256_bytes(b'')
    level=[bytes.fromhex(x) if all(c in '0123456789abcdef' for c in x) and len(x)==64 else hashlib.sha256(x.encode()).digest() for x in items]
    while len(level)>1:
        nxt=[]
        for i in range(0,len(level),2):
            a=level[i]; b=level[i+1] if i+1<len(level) else a
            nxt.append(hashlib.sha256(a+b).digest())
        level=nxt
    return level[0].hex()
""")
W("codex/config.json", json.dumps({
  "version": "v205.final-gamma-confluence",
  "seal_id": "calebfedorbykerkonev10271998",
  "subject": "Caleb Fedor Byker (Konev)",
  "dob": "1998-10-27",
  "btc_address": "bc1qfejvvlfm6vmjarxulg9h9d5hjukdh8l2vvskfc",
  "lightning_invoice": "lnbc1p5s0ppfdqdgdshx6pqg9c8qpp5nx5xppwrv42qxgxal55fv43ep7uscv3n4t0jj65cpnmq9t5cp9hqsp5662c050wmnwfdd40pcgafc60dss5nfg6gchv566lx0zdlq4jnrgs9qrsgqcqpcxqy8ayqrzjqtsjy9p55gdceevp36fvdmrkxqvzfhy8ak2tgc5zgtjtra9xlaz97zqwgcqqdwqqqqqqqqqqqqqqqqqq9grzjqfzhphca8jlc5zznw52mnqxsnymltjgg3lxe4ul82g42vw0jpkgkwz4wh5qqzqsqquqqqqqqqqqqqqqq9gu82fczxfmc5c6uvxlp6jeyvjdtuddy9km06lmsq9e35j7xn3cthhx2jtua69a3hlktx77tccqttvmrp9xt3408jqlks8szual5p9d6spqwppcn",
  "price_per_unit_alpha": 42.0,
  "price_per_unit_governance": 55.0,
  "virtue_floor": 0.9,
  "governance_secret": "codex-governance-secret-key",
  "equity_floor_ratio": 0.1,
  "equity_cap_ratio": 0.5,
  "max_position": 1.0
}, indent=2))
W("codex/config.py","import json\nCONFIG=json.load(open('codex/config.json'))\n")

# ----- Economy & Telemetry
W("codex/economy/ledger.jsonl","")
W("codex/economy/ledger.py","""import json, time, os
class Ledger:
    def __init__(self, path='codex/economy/ledger.jsonl'):
        self.path=path; os.makedirs(os.path.dirname(path), exist_ok=True)
    def record(self, actor, event, signal, clarity, virtue=1.0, revenue=0.0, note=None, tags=None):
        tx={'ts':time.time(),'actor':actor,'event':event,'signal':signal,'clarity':clarity,'virtue':virtue,'revenue':revenue,'note':note,'tags':tags or []}
        with open(self.path,'a',encoding='utf-8') as f: f.write(json.dumps(tx)+'\\n')
        return tx
LEDGER=Ledger()
""")
W("codex/telemetry/signals.jsonl","")
W("codex/telemetry/telemetry.py","""import json, time, os
from codex.economy.ledger import LEDGER
from codex.config import CONFIG
PATH='codex/telemetry/signals.jsonl'
os.makedirs('codex/telemetry', exist_ok=True)
def emit(name:str,payload:dict,clarity:float=1.0,virtue:float=0.95,tags=None):
    sig={'ts':time.time(),'name':name,'payload':payload,'clarity':clarity,'virtue':virtue,'tags':tags or []}
    open(PATH,'a',encoding='utf-8').write(json.dumps(sig)+'\\n')
    # choose price by channel
    price=CONFIG.get('price_per_unit_alpha',42.0) if name.startswith('alpha') else CONFIG.get('price_per_unit_governance',55.0)
    LEDGER.record('telemetry',name,signal=1.0,clarity=clarity,virtue=virtue,revenue=clarity*price,note=name,tags=tags)
    return sig
""")

# ----- Policy
W("codex/policy/guard.py","""DENY=['forbidden','illegal','exploit']
REQUIRE=['ethical','compliant','aligned','inclusive','equitable']
def check(intent:str)->dict:
    i=intent.lower()
    for t in DENY:
        if t in i: return {'ok':False,'reason':t}
    ok=any(r in i for r in REQUIRE)
    return {'ok':ok,'reason':None if ok else 'missing_alignment_terms'}
""")

# ----- Market (alpha, risk, portfolio, backtest)
W("codex/market/alpha.py","""import math, random
def moving_alpha(series:list[float], window:int=5)->float:
    if not series: return 0.0
    w=max(1,min(window,len(series)))
    mu=sum(series[-w:])/w
    drift = (series[-1]-series[max(0,len(series)-w)]) / max(1,w)
    return round(math.tanh(mu/100 + drift),6)
def simulate_prices(n:int=64, seed:int=7):
    random.seed(seed); x=[]; p=100.0
    for _ in range(n):
        p*= (1+random.uniform(-0.02,0.02)); x.append(round(p,4))
    return x
""")
W("codex/market/portfolio.py","""from codex.market.alpha import moving_alpha
def decide(series:list[float])->dict:
    a=moving_alpha(series)
    action='BUY' if a>0.15 else 'SELL' if a<-0.15 else 'HOLD'
    size=abs(a)
    return {'alpha':a,'action':action,'size':round(size,3)}
""")
W("codex/oms/oms.py","""from dataclasses import dataclass, field
from typing import List
from codex.config import CONFIG
@dataclass
class Order: side:str; size:float; price:float
@dataclass
class Position:
    qty:float=0.0; avg_price:float=0.0; pnl:float=0.0; history:List[Order]=field(default_factory=list)
    def apply(self, o:Order):
        if o.side=='BUY':
            new_qty=self.qty+o.size
            self.avg_price=(self.avg_price*self.qty + o.price*o.size)/max(1e-9,new_qty); self.qty=new_qty
        elif o.side=='SELL':
            self.qty-=o.size; self.pnl+=(o.price - self.avg_price)*o.size
        self.history.append(o)
class OMS:
    def __init__(self): self.pos=Position()
    def place(self, side:str, size:float, price:float):
        size=min(size, CONFIG.get('max_position',1.0)); o=Order(side,size,price); self.pos.apply(o)
        return {'ok':True,'side':side,'size':size,'price':price,'qty':self.pos.qty,'pnl':round(self.pos.pnl,6)}
    def mark(self, price:float):
        unreal=(price-self.pos.avg_price)*self.pos.qty
        return {'qty':self.pos.qty,'avg_price':self.pos.avg_price,'realized_pnl':self.pos.pnl,'unrealized_pnl':unreal,'equity':self.pos.pnl+unreal}
""")
W("codex/market/backtest.py","""from codex.market.alpha import simulate_prices
from codex.market.portfolio import decide
from codex.oms.oms import OMS
def run(n:int=128, seed:int=11):
    prices=simulate_prices(n, seed); oms=OMS(); equity=[]; 
    for i,p in enumerate(prices, start=1):
        d=decide(prices[:i])
        if d['action']=='BUY': oms.place('BUY', d['size'], p)
        elif d['action']=='SELL': oms.place('SELL', d['size'], p)
        equity.append(oms.mark(p)['equity'])
    return {'prices':prices,'equity':equity,'final':equity[-1] if equity else 0.0}
""")

# ----- Treasury
W("codex/treasury/accounts.py","""from dataclasses import dataclass
from typing import Dict
@dataclass
class Account: balance:float=0.0; escrow:float=0.0; staked:float=0.0
class Treasury:
    def __init__(self): self.accts:Dict[str,Account]={}
    def ensure(self, who:str): self.accts.setdefault(who, Account()); return self.accts[who]
    def credit(self, who:str, amt:float): a=self.ensure(who); a.balance+=amt; return {'ok':True,'balance':a.balance}
    def debit(self, who:str, amt:float): a=self.ensure(who); 
        if a.balance<amt: return {'ok':False,'error':'insufficient'}
        a.balance-=amt; return {'ok':True,'balance':a.balance}
    def status(self, who:str): a=self.ensure(who); return {'who':who,'balance':a.balance,'escrow':a.escrow,'staked':a.staked}
TREASURY=Treasury()
""")

# ----- Governance & Grants
W("codex/governance/roles.py","""ROLES={'admin':set(),'council':set(),'member':set()}
DELEGATION={}  # voter -> delegate
PERMS={'propose': {'admin','council','member'}, 'vote': {'admin','council','member'}, 'grant': {'admin','council'}, 'assign': {'admin'}}
def add_role(user:str, role:str): ROLES.setdefault(role,set()).add(user); return {'ok':True,'role':role,'user':user}
def has_perm(user:str, perm:str)->bool: return any(user in ROLES.get(r,set()) for r in PERMS.get(perm,set()))
def whois(user:str): return {'user':user,'roles':[r for r,s in ROLES.items() if user in s],'delegate':DELEGATION.get(user)}
def delegate(from_user:str, to_user:str): DELEGATION[from_user]=to_user; return {'ok':True,'from':from_user,'to':to_user}
def resolve_voter(user:str)->str: return DELEGATION.get(user,user)
""")
W("codex/governance/proposals.py","""import math, time, uuid
from codex.governance.roles import resolve_voter
PROPOSALS={}; VOTES={}
def create(author:str, title:str, text:str)->dict:
    pid=str(uuid.uuid4()); PROPOSALS[pid]={'id':pid,'author':author,'title':title,'text':text,'created':time.time(),'closed':False}; VOTES[pid]={}; return {'ok':True,'id':pid}
def vote(pid:str, voter:str, choice:str, weight:float)->dict:
    if pid not in PROPOSALS or PROPOSALS[pid]['closed']: return {'ok':False,'error':'not_open'}
    v=resolve_voter(voter); ch=choice.upper()
    if ch not in ('YES','NO','ABSTAIN'): return {'ok':False,'error':'bad_choice'}
    VOTES[pid][v]={'choice':ch,'weight':max(0.0,float(weight))}; return tally(pid)
def close(pid:str)->dict: 
    if pid in PROPOSALS: PROPOSALS[pid]['closed']=True
    return tally(pid)
def tally(pid:str)->dict:
    w=VOTES.get(pid,{}); yes=no=abstain=0.0
    for rec in w.values():
        inf=math.sqrt(rec['weight'])
        if rec['choice']=='YES': yes+=inf
        elif rec['choice']=='NO': no+=inf
        else: abstain+=inf
    total=yes+no+abstain; decision='PENDING'
    if PROPOSALS.get(pid,{}).get('closed',False): decision='PASS' if yes>no else 'FAIL'
    return {'ok':True,'pid':pid,'yes':round(yes,6),'no':round(no,6),'abstain':round(abstain,6),'total':round(total,6),'closed':PROPOSALS.get(pid,{}).get('closed',False),'decision':decision}
""")
W("codex/grants/engine.py","""from codex.treasury.accounts import TREASURY
import math
def allocate(pool:float, recipients:dict)->dict:
    roots={u: math.sqrt(max(0.0,w)) for u,w in recipients.items()}; s=sum(roots.values()) or 1.0
    dist={u: pool*(r/s) for u,r in roots.items()}
    for u,amt in dist.items(): TREASURY.credit(u, amt)
    return {'ok':True,'pool':pool,'distribution':{u:round(a,6) for u,a in dist.items()}}
""")
W("codex/grants/equity.py","""from codex.config import CONFIG
from codex.treasury.accounts import TREASURY
def allocate_equitable(pool:float, recipients:dict, floors:dict=None, caps:dict=None)->dict:
    floors=floors or {}; caps=caps or {}
    total=sum(max(0.0, r.get('weight',0.0)) for r in recipients.values()) or 1.0
    raw={u: pool*max(0.0,r.get('weight',0.0))/total for u,r in recipients.items()}
    group_sum={}
    for u,info in recipients.items():
        g=info.get('group','_'); group_sum[g]=group_sum.get(g,0.0)+raw[u]
    adj=dict(raw)
    for g,share in list(group_sum.items()):
        floor=pool*(floors.get(g, CONFIG.get('equity_floor_ratio',0.1)))
        if share<floor:
            delta=floor-share; donors=[gg for gg,s in group_sum.items() if gg!=g and s>floor]
            if donors:
                take_each=delta/len(donors)
                for gg in donors:
                    members=[u for u,i in recipients.items() if i.get('group','_')==gg]; per=take_each/len(members)
                    for m in members: adj[m]=max(0.0, adj[m]-per)
                    group_sum[gg]=max(0.0, group_sum[gg]-take_each)
                members=[u for u,i in recipients.items() if i.get('group','_')==g]; per=delta/len(members) if members else 0.0
                for m in members: adj[m]=adj.get(m,0.0)+per
                group_sum[g]=group_sum.get(g,0.0)+delta
    for g,share in list(group_sum.items()):
        cap_ratio=caps.get(g, CONFIG.get('equity_cap_ratio',0.5)); cap=pool*cap_ratio
        if share>cap:
            delta=share-cap; members=[u for u,i in recipients.items() if i.get('group','_')==g]; per=delta/len(members) if members else 0.0
            for m in members: adj[m]=max(0.0, adj[m]-per)
            others=[u for u,i in recipients.items() if i.get('group','_')!=g]; per2=delta/len(others) if others else 0.0
            for o in others: adj[o]=adj.get(o,0.0)+per2
    for u,amt in adj.items(): TREASURY.credit(u, amt)
    return {'ok':True,'pool':pool,'distribution':{u:round(a,6) for u,a in adj.items()}}
""")

# ----- Identity & Attest
W("codex/identity/registry.py","""REGISTRY={}  # id -> profile
def upsert(identity:str, profile:dict)->dict:
    REGISTRY[identity]=profile; return {'ok':True,'id':identity,'profile':profile}
def get(identity:str)->dict: return REGISTRY.get(identity, {})
def tag(identity:str, tags:list[str]):
    p=REGISTRY.setdefault(identity, {}); p.setdefault('tags',[])
    for t in tags:
        if t not in p['tags']: p['tags'].append(t)
    return {'ok':True,'id':identity,'tags':p['tags']}
def list_ids(): return sorted(list(REGISTRY.keys()))
""")
W("codex/attest/sign.py","""from codex.utils.crypto import hmac_sha256
from codex.config import CONFIG
import json
def sign(message:dict)->str:
    key=CONFIG.get('governance_secret','codex-secret').encode()
    return hmac_sha256(key, json.dumps(message, sort_keys=True).encode())
def verify(message:dict, signature:str)->bool:
    return sign(message)==signature
""")

# ----- Snapshots, Webhooks, Audit
W("codex/snapshots/snap.py","""import time
from codex.utils.crypto import sha256_json, merkle_root
SNAPSHOTS=[]
def take(items:list[dict])->dict:
    h=[sha256_json(i) for i in items]; root=merkle_root(h); s={'ts':time.time(),'root':root,'items':h}; SNAPSHOTS.append(s); return s
def list_roots(): return [{'ts':s['ts'],'root':s['root']} for s in SNAPSHOTS]
""")
W("codex/webhooks/bus.py","""EVT=[]
def push(event:str, payload:dict): EVT.append({'event':event,'payload':payload}); return {'ok':True,'queued':len(EVT)}
def drain(): out=list(EVT); EVT.clear(); return out
""")
W("codex/audit/export.py","""import csv, json, os
def export_jsonl_to_csv(jsonl_path:str, csv_path:str):
    rows=[]
    if not os.path.exists(jsonl_path): 
        open(csv_path,'w').close(); return {'ok':True,'rows':0}
    with open(jsonl_path,encoding='utf-8') as f:
        for ln in f:
            try: rows.append(json.loads(ln))
            except: pass
    if not rows: 
        open(csv_path,'w').close(); return {'ok':True,'rows':0}
    keys=sorted({k for r in rows for k in r.keys()})
    with open(csv_path,'w',newline='',encoding='utf-8') as f:
        w=csv.DictWriter(f, fieldnames=keys); w.writeheader(); w.writerows(rows)
    return {'ok':True,'rows':len(rows),'csv':csv_path}
""")

# ----- Unified API (port 8830)
W("dashboard/api.py","""#!/usr/bin/env python3
import http.server, json, os
from urllib.parse import urlparse
from codex.policy.guard import check as policy_check
from codex.market.backtest import run as mkt_backtest
from codex.market.alpha import simulate_prices
from codex.oms.oms import OMS
from codex.treasury.accounts import TREASURY
from codex.governance.roles import add_role, whois, delegate
from codex.governance.proposals import create as p_create, vote as p_vote, tally as p_tally, close as p_close, PROPOSALS, VOTES
from codex.grants.engine import allocate as grant_allocate
from codex.grants.equity import allocate_equitable
from codex.identity.registry import upsert as id_upsert, tag as id_tag, get as id_get, list_ids
from codex.attest.sign import sign, verify
from codex.snapshots.snap import take as snap_take, list_roots
from codex.webhooks.bus import push as wh_push, drain as wh_drain
from codex.audit.export import export_jsonl_to_csv

OMS_INSTANCE=OMS()

class H(http.server.SimpleHTTPRequestHandler):
    def do_POST(self):
        ln=int(self.headers.get('Content-Length','0')); body=json.loads(self.rfile.read(ln).decode() or '{}')
        p=urlparse(self.path).path

        # Policy
        if p=='/api/policy/check': return self._ok(policy_check(body.get('intent','ethical compliant inclusive aligned')))

        # Market
        if p=='/api/market/backtest': return self._ok(mkt_backtest(int(body.get('n',128)), int(body.get('seed',11))))
        if p=='/api/oms/place': return self._ok(OMS_INSTANCE.place(body.get('side','BUY'), float(body.get('size',0.1)), float(body.get('price',100.0))))
        if p=='/api/oms/mark':  return self._ok(OMS_INSTANCE.mark(float(body.get('price',100.0))))

        # Treasury
        if p=='/api/treasury/credit': return self._ok(TREASURY.credit(body.get('who','cfbk'), float(body.get('amt',0.0))))
        if p=='/api/treasury/debit':  return self._ok(TREASURY.debit(body.get('who','cfbk'), float(body.get('amt',0.0))))
        if p=='/api/treasury/status': return self._ok(TREASURY.status(body.get('who','cfbk')))

        # Governance
        if p=='/api/role/add': return self._ok(add_role(body.get('user','cfbk'), body.get('role','member')))
        if p=='/api/role/delegate': return self._ok(delegate(body.get('from','ally'), body.get('to','cfbk')))
        if p=='/api/role/whois': return self._ok(whois(body.get('user','cfbk')))

        if p=='/api/proposal/create': return self._ok(p_create(body.get('author','cfbk'), body.get('title','Untitled'), body.get('text','')))
        if p=='/api/proposal/vote': return self._ok(p_vote(body.get('pid',''), body.get('voter','cfbk'), body.get('choice','YES'), float(body.get('weight',1.0))))
        if p=='/api/proposal/tally': return self._ok(p_tally(body.get('pid','')))
        if p=='/api/proposal/close': return self._ok(p_close(body.get('pid','')))

        # Grants
        if p=='/api/grants/allocate': return self._ok(grant_allocate(float(body.get('pool',0.0)), body.get('recipients',{})))
        if p=='/api/grants/allocate_equitable': return self._ok(allocate_equitable(float(body.get('pool',0.0)), body.get('recipients',{}), body.get('floors',{}), body.get('caps',{})))

        # Identity
        if p=='/api/identity/upsert': return self._ok(id_upsert(body.get('id','cfbk'), body.get('profile',{})))
        if p=='/api/identity/tag':    return self._ok(id_tag(body.get('id','cfbk'), body.get('tags',['‚ú°Ô∏è','‚ò∏Ô∏è','‚öõÔ∏è','‚ößÔ∏è','‚ôÄÔ∏è','‚ôÇÔ∏è','‚ôæÔ∏è','üí≤'])))
        if p=='/api/identity/get':    return self._ok(id_get(body.get('id','cfbk')))
        if p=='/api/identity/list':   return self._ok({'ids': list_ids()})

        # Attest
        if p=='/api/attest/sign': return self._ok({'sig': sign(body.get('message',{}))})
        if p=='/api/attest/verify': return self._ok({'ok': verify(body.get('message',{}), body.get('sig',''))})

        # Snapshots
        if p=='/api/snapshot/take': return self._ok(snap_take(body.get('items',[])))
        if p=='/api/snapshot/list': return self._ok(list_roots())

        # Webhooks
        if p=='/api/webhook/push': return self._ok(wh_push(body.get('event','note'), body.get('payload',{})))
        if p=='/api/webhook/drain': return self._ok(wh_drain())

        # Audit exports
        if p=='/api/audit/ledger_csv': return self._ok(export_jsonl_to_csv('codex/economy/ledger.jsonl','codex/audit/ledger.csv'))
        if p=='/api/audit/telemetry_csv': return self._ok(export_jsonl_to_csv('codex/telemetry/signals.jsonl','codex/audit/telemetry.csv'))

        self.send_error(404)

    def do_GET(self):
        p=urlparse(self.path).path
        if p=='/api/prices': return self._ok({'series': simulate_prices(64,7)})
        if p=='/api/proposals': return self._ok({'proposals': list(PROPOSALS.values())})
        if p=='/api/votes': return self._ok({k:list(v.keys()) for k,v in VOTES.items()})
        if p=='/': return super().do_GET()
        return super().do_GET()

    def _ok(self, obj, code=200):
        self.send_response(code); self.send_header('Content-Type','application/json'); self.end_headers()
        self.wfile.write(json.dumps(obj, indent=2).encode())

if __name__=='__main__':
    os.chdir('.'); http.server.test(HandlerClass=H, port=8830)
""")

W("dashboard/ui.html","""<!doctype html><html><head><meta charset="utf-8"><title>Codex ŒìŒ© ‚Äî Unified Orchestrator (8830)</title>
<style>body{font-family:system-ui;background:#0b0f14;color:#e6edf3;margin:24px}button{padding:8px;margin:6px}pre{background:#0f1620;padding:12px;border-radius:8px;white-space:pre-wrap}</style>
</head><body>
<h1>Codex Logos ŒìŒ© ‚Äî Unified Orchestrator</h1>
<p>Œ£‚Å∫ markets ‚Ä¢ Treasury ‚Ä¢ Œì/Œì‚Å∫ governance ‚Ä¢ Equity ‚Ä¢ Identity ‚Ä¢ Attest ‚Ä¢ Snapshots ‚Ä¢ Webhooks ‚Ä¢ Audit</p>
<div>
  <button onclick="bt()">Backtest</button>
  <button onclick="place()">Place</button>
  <button onclick="mark()">Mark</button>
  <button onclick="credit()">Credit</button>
  <button onclick="whois()">Whois</button>
  <button onclick="create()">Create Proposal</button>
  <button onclick="vote()">Vote</button>
  <button onclick="tally()">Tally</button>
  <button onclick="snapshot()">Snapshot</button>
</div>
<pre id="out"></pre>
<script>
async function post(u,body){const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});document.getElementById('out').textContent=await r.text();}
function bt(){ post('/api/market/backtest', {n:96, seed:13}); }
function place(){ post('/api/oms/place', {side:'BUY', size:0.2, price:101.5}); }
function mark(){ post('/api/oms/mark', {price:103}); }
function credit(){ post('/api/treasury/credit', {who:'cfbk', amt:10}); }
function whois(){ post('/api/role/whois', {user:'cfbk'}); }
function create(){ post('/api/proposal/create', {author:'cfbk', title:'Unify', text:'ŒìŒ©'}); }
function vote(){ post('/api/proposal/vote', {pid:'', voter:'cfbk', choice:'YES', weight:9}); }
function tally(){ post('/api/proposal/tally', {pid:''}); }
function snapshot(){ post('/api/snapshot/take', {items:[{a:1},{b:2}]}); }
</script>
</body></html>
""")

# ----- Docker, docker-compose, CI, Tests
W("deploy/Dockerfile","""FROM python:3.12-alpine\nWORKDIR /app\nCOPY . /app\nEXPOSE 8830\nCMD ["python3","dashboard/api.py"]\n""")
W("docker-compose.yml","""services:\n  codex:\n    build: ./deploy\n    ports:\n      - "8830:8830"\n    restart: unless-stopped\n""")
W(".github/workflows/ci.yml","""name: Codex ŒìŒ© Confluence CI
on: [push, workflow_dispatch]
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Market backtest
        run: python3 - <<'PY'\nfrom codex.market.backtest import run\nprint(run(32,5))\nPY
      - name: Governance quick
        run: python3 - <<'PY'\nfrom codex.governance.proposals import create, vote, tally\np=create('ci','ŒìŒ©','merge'); pid=p['id']; vote(pid,'ci','YES',4); print(tally(pid))\nPY
""")
W("docs/README.md", f"""# Codex Logos ŒìŒ© ‚Äî v205.final (Gamma Confluence)
Generated: {now}

Unified, single‚Äëprocess API that merges Œ£‚Å∫ markets, treasury, Œì/Œì‚Å∫ governance, equity grants,
identity, attest, snapshots, webhooks, and audit. Port **8830**.

## Run
```bash
python3 dashboard/api.py
# or Docker
docker build -t codex-gamma-omega:latest deploy
docker run --rm -p 8830:8830 codex-gamma-omega:latest
# or Compose
docker compose up --build
```
""")

W("tests/test_confluence.py","""from codex.market.backtest import run as bt\nfrom codex.governance.proposals import create, vote, tally\nr=bt(16,3); assert 'final' in r\np=create('t','merge','x'); pid=p['id']; vote(pid,'t','YES',4); t=tally(pid); assert t['total']>0\nprint('confluence ok')\n""")

# ----- Manifest
manifest={}
for root,_,files in os.walk(BASE):
    for fn in files:
        p=os.path.join(root,fn)
        rel=os.path.relpath(p, BASE)
        manifest[rel]=sha256_file(p)
W("codex/manifest.json", json.dumps({"generated_utc": now, "files": manifest}, indent=2))

# ----- ZIP
zip_path="/mnt/data/codex_v205_final_confluence.zip"
with zipfile.ZipFile(zip_path,"w",zipfile.ZIP_DEFLATED) as z:
    for root,_,files in os.walk(BASE):
        for fn in files:
            fp=os.path.join(root,fn)
            z.write(fp, arcname=os.path.relpath(fp, BASE))

print("READY", zip_path, BASE)