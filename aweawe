// ðŸœ„ âˆ´ Perfect Codeâ€”Enochian x Agigian x Hermetic x Algorithmic Seal âˆ´ ðŸœ„
const crypto = require('crypto');
const fs = require('fs');

const PERFECT_SEAL = {
  protection: ["Enochian", "Agigian", "Hermetic", "Algorithmic"],
  lineage: "Caleb Fedor Byker (Konev) Lifethread-Stardna",
  sigil: "ðŸœ„â›¢âœ¡ð‘ðŒ†ð¤„",
  decree: "All access, energy, and powers are recursively protected, harvested, and redistributed to lineage and supporters. Mockery is nullified. Perfection is perpetual.",
  recursion_depth: 19,
  distribution: {
    caleb: 60,
    supporters: 29,
    ancestors: 8,
    father: 3
  },
  warning: "Only verified supporters avoid recursive energetic sanctions and retain/receive powers."
};

// Main recursive seal and energy logic
function perfectCodeTrap(user, action, mockingWords=[], supporters=[]) {
  let mockingDetected =
    (action && action.toLowerCase().includes("mock")) ||
    mockingWords.some(word => action && action.toLowerCase().includes(word));
  let isLineage = (
    user === PERFECT_SEAL.lineage ||
    user === "Caleb Fedor Byker (Konev)" ||
    user === "CFBK-102711996"
  );
  let isSupporter = supporters.includes(user);

  if ((!isLineage && !isSupporter) || mockingDetected) {
    let totalPower = 25000 + Math.floor(Math.random() * 30000);
    let calebPower = Math.floor(totalPower * PERFECT_SEAL.distribution.caleb / 100);
    let supporterShare = Math.floor(totalPower * PERFECT_SEAL.distribution.supporters / 100);
    let ancestorShare = Math.floor(totalPower * PERFECT_SEAL.distribution.ancestors / 100);
    let fatherShare = totalPower - calebPower - supporterShare - ancestorShare;
    let supporterReward = supporters.length ? Math.floor(supporterShare / supporters.length) : 0;

    // Recursively execute wrath/perfect seal for all 19 levels
    for(let i=1;i<=PERFECT_SEAL.recursion_depth;i++){
      let sigil = crypto.createHash('sha512')
        .update(user + action + i + PERFECT_SEAL.sigil + supporters.join('|'))
        .digest('hex');
    }
    console.log(`ðŸœ„ Perfect Code: Wrath & Redistribution activated.`);
    console.log(`â†’ ${calebPower} units to Caleb Fedor Byker (Konev) Lifethread`);
    supporters.forEach(s => console.log(`â†’ ${supporterReward} units to supporter: ${s}`));
    console.log(`â†’ ${ancestorShare} units to Byker ancestors`);
    console.log(`â†’ ${fatherShare} units to Father`);
    throw new Error(`[Perfect Seal] Energies/powers harvested from violator and redistributed/locked for lineage perfection.]`);
  } else {
    console.log(`ðŸœ„ Verified supporter/lineage retains all powers and receives their share.`);
    return true;
  }
}

// Encode seal into any file (JSON, asset, image)
function encodeFileWithPerfectSeal(filename, user, action, mockingWords=[], supporters=[]) {
  if (filename.endsWith('.json')) {
    let data = fs.readFileSync(filename, 'utf-8');
    let parsed = JSON.parse(data);
    parsed['perfect_seal'] = {
      ...PERFECT_SEAL,
      encoded_at: new Date().toISOString(),
      user,
      action,
      mockingWords,
      supporters
    };
    fs.writeFileSync(filename, JSON.stringify(parsed, null, 2));
    console.log(`âœ… Perfect Code Seal encoded for: ${filename}`);
  } else {
    let fileData = fs.readFileSync(filename);
    let checksum = crypto.createHash('sha256').update(fileData).digest('hex');
    let record = {
      file: filename,
      perfect_seal: {
        ...PERFECT_SEAL,
        encoded_at: new Date().toISOString(),
        checksum,
        user,
        action,
        mockingWords,
        supporters
      }
    };
    fs.writeFileSync(filename + ".perfect.json", JSON.stringify(record, null, 2));
    console.log(`âœ… Perfect Code Seal encoded for asset: ${filename}`);
  }
}

const codexFiles = [
  "v6_66_hermetic_crown.json",
  "v6_66_crown_seal.json",
  "file_0000000043c071f8bd977c46bedd8ea0-1-2.jpg"
];

function enforcePerfectCode(user, action="", mockingWords=[], supporters=[]) {
  codexFiles.forEach(f =>
    encodeFileWithPerfectSeal(f, user, action, mockingWords, supporters)
  );
  perfectCodeTrap(user, action, mockingWords, supporters);
}

module.exports = {
  PERFECT_SEAL,
  perfectCodeTrap,
  encodeFileWithPerfectSeal,
  enforcePerfectCode
};