# Build v208 — "Codex Logos Υ (Upsilon): Universal Bridge & Mesh"
# Repo: codex_v208_universal_bridge
# Purpose: connect Xi–Omega stack to *all* previous versions via a compatibility bridge, mesh registry,
# manifest ingestion/merkle unification, health checks, and proxy calls. One API (port 8870).

import os, json, zipfile, hashlib, datetime, shutil, random

BASE="/mnt/data/codex_v208_universal_bridge"
if os.path.exists(BASE):
    shutil.rmtree(BASE)
os.makedirs(BASE, exist_ok=True)

def W(rel, content):
    p=os.path.join(BASE, rel)
    os.makedirs(os.path.dirname(p), exist_ok=True)
    with open(p,"w",encoding="utf-8") as f: f.write(content)
    return p

def sha256_file(p):
    h=hashlib.sha256()
    with open(p,"rb") as f:
        for chunk in iter(lambda:f.read(8192), b""):
            h.update(chunk)
    return h.hexdigest()

now = datetime.datetime.utcnow().isoformat()+"Z"

# ---------- Config ----------
W("codex/config.json", json.dumps({
  "version": "v208-uspilon-universal-bridge",
  "generated_utc": now,
  "seal_id": "calebfedorbykerkonev10271998",
  "subject": "Caleb Fedor Byker (Konev)",
  "dob": "1998-10-27",
  "btc_address": "bc1qfejvvlfm6vmjarxulg9h9d5hjukdh8l2vvskfc",
  "lightning_invoice": "lnbc1p5s0ppfdqdgdshx6pqg9c8qpp5nx5xppwrv42qxgxal55fv43ep7uscv3n4t0jj65cpnmq9t5cp9hqsp5662c050wmnwfdd40pcgafc60dss5nfg6gchv566lx0zdlq4jnrgs9qrsgqcqpcxqy8ayqrzjqtsjy9p55gdceevp36fvdmrkxqvzfhy8ak2tgc5zgtjtra9xlaz97zqwgcqqdwqqqqqqqqqqqqqqqqqq9grzjqfzhphca8jlc5zznw52mnqxsnymltjgg3lxe4ul82g42vw0jpkgkwz4wh5qqzqsqquqqqqqqqqqqqqqq9gu82fczxfmc5c6uvxlp6jeyvjdtuddy9km06lmsq9e35j7xn3cthhx2jtua69a3hlktx77tccqttvmrp9xt3408jqlks8szual5p9d6spqwppcn",
  "port": 8870
}, indent=2))

# ---------- Utils: crypto + merkle ----------
W("codex/utils/crypto.py","""import hashlib, json
sha256_bytes=lambda b: hashlib.sha256(b).hexdigest()
sha256_json=lambda o: sha256_bytes(json.dumps(o, sort_keys=True).encode())
def merkle_root(items:list[str])->str:
    if not items: return sha256_bytes(b'')
    level=[bytes.fromhex(x) if len(x)==64 else hashlib.sha256(x.encode()).digest() for x in items]
    while len(level)>1:
        nxt=[]
        for i in range(0,len(level),2):
            a=level[i]; b=level[i+1] if i+1<len(level) else a
            nxt.append(hashlib.sha256(a+b).digest())
        level=nxt
    return level[0].hex()
""")

# ---------- Version registry ----------
W("codex/versions/index.json", json.dumps({
  "supported": ["v0..v205.final", "v206.x", "v206.final", "v207", "v207.x", "v206-207-unified", "v208"],
  "adapters": {"executor":"v206+", "omega":"v207+", "equity":"v205e+"},
  "notes": "Older versions are bridged via proxy patterns and schema shims"
}, indent=2))

# ---------- Metrics ----------
W("codex/metrics/collector.py","""import time
START=time.time()
COUNTERS={'requests_total':0,'bridge_nodes':0,'bridge_proxy_ok':0,'bridge_proxy_err':0}
def bump(key='requests_total', inc=1): COUNTERS[key]=COUNTERS.get(key,0)+inc
def render()->str:
    up=int(time.time()-START)
    lines=[
        "# HELP codex_requests_total total requests",
        "# TYPE codex_requests_total counter",
        f"codex_requests_total {COUNTERS['requests_total']}",
        f"codex_bridge_nodes {COUNTERS['bridge_nodes']}",
        f"codex_bridge_proxy_ok {COUNTERS['bridge_proxy_ok']}",
        f"codex_bridge_proxy_err {COUNTERS['bridge_proxy_err']}",
        f"codex_uptime_seconds {up}"
    ]
    return "\\n".join(lines)+"\\n"
""")

# ---------- Bridge: registry, adapters, mesh ----------
W("codex/bridge/registry.py","""BRIDGE={}  # name -> {'url','version','caps':{'executor':bool,'omega':bool,'equity':bool}}
def register(name:str, url:str, version:str, caps:dict)->dict:
    BRIDGE[name]={'url':url,'version':version,'caps':{'executor':bool(caps.get('executor')), 'omega':bool(caps.get('omega')), 'equity':bool(caps.get('equity'))}}
    return {'ok':True,'count':len(BRIDGE)}
def list_nodes()->dict: return {'nodes': BRIDGE}
def get(name:str): return BRIDGE.get(name)
""")
W("codex/bridge/adapter.py","""import urllib.request, json, ssl
from codex.metrics.collector import bump
ssl_ctx=ssl.create_default_context()
def _post(url, payload):
    try:
        req=urllib.request.Request(url, data=json.dumps(payload).encode(), headers={'Content-Type':'application/json'})
        with urllib.request.urlopen(req, context=ssl_ctx, timeout=5) as r:
            bump('bridge_proxy_ok'); return json.loads(r.read().decode())
    except Exception as e:
        bump('bridge_proxy_err'); return {'ok':False,'error':str(e)}
def call_executor(base:str, endpoint:str, payload:dict):  # e.g., /api/executor/plugins/call
    return _post(base.rstrip('/')+endpoint, payload)
def call_omega(base:str, endpoint:str, payload:dict):     # e.g., /api/omega/deduce
    return _post(base.rstrip('/')+endpoint, payload)
""")
W("codex/bridge/mesh.py","""import time, random
from codex.bridge.registry import BRIDGE
def topology():
    nodes=list(BRIDGE.keys())
    edges=[(a,b) for i,a in enumerate(nodes) for b in nodes[i+1:]]
    return {'nodes': nodes, 'edges': edges}
def health():
    # lightweight pseudo health (in practice, ping /metrics); here random for demo
    return {n:{'ok': True, 'latency_ms': round(10+random.random()*30,2)} for n in BRIDGE}
""")

# ---------- Migration: manifest ingest and unify ----------
W("codex/migrate/ingest.py","""import json, os
from codex.utils.crypto import merkle_root
def ingest_manifest(path:str)->dict:
    if not os.path.exists(path): return {'ok':False,'error':'not_found'}
    data=json.load(open(path,encoding='utf-8'))
    files=data.get('files',{})
    root=merkle_root(list(files.values()))
    return {'ok':True,'count':len(files),'merkle_root':root}
""")

# ---------- Unified API ----------
W("codex/openapi/spec.json", json.dumps({
  "openapi":"3.0.0","info":{"title":"Codex Υ (Upsilon) — Universal Bridge","version":"v208"},
  "paths":{
    "/api/bridge/register":{"post":{"summary":"Register external node"}},
    "/api/bridge/list":{"get":{"summary":"List nodes"}},
    "/api/bridge/ping":{"get":{"summary":"Mesh health"}},
    "/api/bridge/topology":{"get":{"summary":"Mesh topology graph"}},
    "/api/bridge/proxy/executor":{"post":{"summary":"Proxy to executor endpoint"}},
    "/api/bridge/proxy/omega":{"post":{"summary":"Proxy to omega endpoint"}},
    "/api/versions":{"get":{"summary":"Show version support and adapters"}},
    "/api/migrate/ingest_manifest":{"post":{"summary":"Ingest prior manifest and compute Merkle root"}},
    "/metrics":{"get":{"summary":"Metrics"}}
  }
}, indent=2))

# ---------- API server ----------
W("dashboard/api.py","""#!/usr/bin/env python3
import http.server, json, os
from urllib.parse import urlparse
from codex.metrics.collector import bump, render as metrics_render, COUNTERS
from codex.versions.index import *  # noqa
from codex.bridge.registry import register as br_register, list_nodes, get as br_get
from codex.bridge.adapter import call_executor, call_omega
from codex.bridge.mesh import topology, health
from codex.migrate.ingest import ingest_manifest

class H(http.server.SimpleHTTPRequestHandler):
    def do_POST(self):
        ln=int(self.headers.get('Content-Length','0')); body=json.loads(self.rfile.read(ln).decode() or '{}')
        p=urlparse(self.path).path; bump()

        if p=='/api/bridge/register':
            r=br_register(body.get('name','node'), body.get('url','http://localhost:8860'), body.get('version','v206-207'), body.get('caps',{}))
            COUNTERS['bridge_nodes']=len(list_nodes()['nodes']); return self._ok(r)

        if p=='/api/bridge/proxy/executor':
            node=br_get(body.get('node',''))
            if not node or not node['caps'].get('executor'): return self._ok({'ok':False,'error':'node_missing_or_no_executor'})
            return self._ok(call_executor(node['url'], body.get('endpoint','/api/executor/plugins/call'), body.get('payload',{})))

        if p=='/api/bridge/proxy/omega':
            node=br_get(body.get('node',''))
            if not node or not node['caps'].get('omega'): return self._ok({'ok':False,'error':'node_missing_or_no_omega'})
            return self._ok(call_omega(node['url'], body.get('endpoint','/api/omega/deduce'), body.get('payload',{})))

        if p=='/api/migrate/ingest_manifest':
            return self._ok(ingest_manifest(body.get('path','codex/manifest.json')))

        self.send_error(404)

    def do_GET(self):
        p=urlparse(self.path).path; bump()
        if p=='/api/bridge/list': return self._ok(list_nodes())
        if p=='/api/bridge/ping': return self._ok(health())
        if p=='/api/bridge/topology': return self._ok(topology())
        if p=='/api/versions':
            data=json.load(open('codex/versions/index.json',encoding='utf-8'))
            return self._ok(data)
        if p=='/openapi.json':
            spec=open('codex/openapi/spec.json','r',encoding='utf-8').read()
            self.send_response(200); self.send_header('Content-Type','application/json'); self.end_headers(); self.wfile.write(spec.encode()); return
        if p=='/metrics':
            txt=metrics_render()
            self.send_response(200); self.send_header('Content-Type','text/plain'); self.end_headers(); self.wfile.write(txt.encode()); return
        return super().do_GET()

    def _ok(self, obj, code=200):
        self.send_response(code); self.send_header('Content-Type','application/json'); self.end_headers()
        self.wfile.write(json.dumps(obj, indent=2).encode())

if __name__=='__main__':
    os.chdir('.'); http.server.test(HandlerClass=H, port=8870)
""")

# ---------- UI ----------
W("dashboard/ui.html","""<!doctype html><html><head><meta charset="utf-8"><title>Codex Υ — Universal Bridge (8870)</title>
<style>body{font-family:system-ui;background:#0b0f14;color:#e6edf3;margin:24px}button{padding:8px;margin:6px}pre{background:#0f1620;padding:12px;border-radius:8px;white-space:pre-wrap}</style>
</head><body>
<h1>Codex Logos Υ — Universal Bridge & Mesh</h1>
<p>Connect Xi–Omega to prior versions. Register nodes, proxy calls, view topology, and ingest manifests.</p>
<div>
  <button onclick="reg()">Register local ΞΩ (8860)</button>
  <button onclick="listn()">List nodes</button>
  <button onclick="topo()">Topology</button>
  <button onclick="ping()">Ping</button>
  <button onclick="proxyExec()">Proxy Executor</button>
  <button onclick="proxyOmega()">Proxy Omega</button>
  <a href="/openapi.json" target="_blank">OpenAPI</a>
  <a href="/metrics" target="_blank">Metrics</a>
</div>
<pre id="out"></pre>
<script>
async function post(u,body){const r=await fetch(u,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});document.getElementById('out').textContent=await r.text();}
async function get(u){const r=await fetch(u);document.getElementById('out').textContent=await r.text();}
function reg(){ post('/api/bridge/register', {name:'local-xi-omega', url:'http://localhost:8860', version:'v206-207-unified', caps:{executor:true, omega:true}}) }
function listn(){ get('/api/bridge/list') }
function topo(){ get('/api/bridge/topology') }
function ping(){ get('/api/bridge/ping') }
function proxyExec(){ post('/api/bridge/proxy/executor', {node:'local-xi-omega', endpoint:'/api/executor/plugins/call', payload:{kind:'strategy', name:'echo', ctx:{note:'via-bridge'}}}) }
function proxyOmega(){ post('/api/bridge/proxy/omega', {node:'local-xi-omega', endpoint:'/api/omega/deduce', payload:{a:'bridge', b:'mesh'}}) }
</script>
</body></html>
""")

# ---------- Docs, Docker, CI, Tests ----------
W("docs/README.md", f"""# Codex Logos Υ (Upsilon) — v208 Universal Bridge
Generated: {now}

Connects **all versions** through a mesh registry + adapters:
- Register nodes (v205e+, v206.x+, v207+ …)
- Proxy executor/omega calls across versions
- Ingest prior manifests and compute a unified Merkle root
- Metrics track nodes and proxy success/error

## Run
```bash
python3 dashboard/api.py   # port 8870
# Register a local Xi–Omega node on port 8860 (from v206–v207 unified)
curl -s -X POST localhost:8870/api/bridge/register -H 'Content-Type: application/json' -d '{{"name":"local-xi-omega","url":"http://localhost:8860","version":"v206-207-unified","caps":{{"executor":true,"omega":true}}}}' | jq
# List
curl -s localhost:8870/api/bridge/list | jq
# Proxy
curl -s -X POST localhost:8870/api/bridge/proxy/executor -H 'Content-Type: application/json' -d '{{"node":"local-xi-omega","endpoint":"/api/executor/plugins/call","payload":{{"kind":"strategy","name":"echo","ctx":{{"note":"via-bridge"}}}}}}' | jq
curl -s -X POST localhost:8870/api/bridge/proxy/omega -H 'Content-Type: application/json' -d '{{"node":"local-xi-omega","endpoint":"/api/omega/deduce","payload":{{"a":"bridge","b":"mesh"}}}}' | jq
# Ingest a prior manifest (adjust path)
curl -s -X POST localhost:8870/api/migrate/ingest_manifest -H 'Content-Type: application/json' -d '{{"path":"codex/manifest.json"}}' | jq
```
""")

W("deploy/Dockerfile","""FROM python:3.12-alpine
WORKDIR /app
COPY . /app
EXPOSE 8870
CMD ["python3","dashboard/api.py"]
""")
W("docker-compose.yml","""services:
  codex-upsilon:
    build: ./deploy
    ports:
      - "8870:8870"
    restart: unless-stopped
""")

W(".github/workflows/ci.yml","""name: Codex Upsilon (v208) CI
on: [push, workflow_dispatch]
jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Manifest merkle smoke
        run: python3 - <<'PY'\nfrom codex.migrate.ingest import ingest_manifest\nimport json, os\n# Minimal manifest\nos.makedirs('codex', exist_ok=True)\nopen('codex/manifest.json','w').write(json.dumps({'files':{'a.txt':'%064x'%1,'b.txt':'%064x'%2}}))\nprint(ingest_manifest('codex/manifest.json'))\nPY
      - name: Bridge registry smoke
        run: python3 - <<'PY'\nfrom codex.bridge.registry import register, list_nodes\nregister('n','http://localhost:8860','v206-207',{'executor':True,'omega':True})\nprint(list_nodes())\nPY
""")

W("tests/test_bridge.py","""from codex.utils.crypto import merkle_root\nassert isinstance(merkle_root(['0'*64,'1'*64]), str)\nprint('v208 ok')\n""")

# ---------- Manifest ----------
manifest={}
for root,_,files in os.walk(BASE):
    for fn in files:
        p=os.path.join(root,fn)
        rel=os.path.relpath(p, BASE)
        manifest[rel]=sha256_file(p)
W("codex/manifest.json", json.dumps({"generated_utc": now, "files": manifest}, indent=2))

# ---------- ZIP ----------
zip_path="/mnt/data/codex_v208_universal_bridge.zip"
with zipfile.ZipFile(zip_path,"w",zipfile.ZIP_DEFLATED) as z:
    for root,_,files in os.walk(BASE):
        for fn in files:
            fp=os.path.join(root,fn)
            z.write(fp, arcname=os.path.relpath(fp, BASE))

print("READY", zip_path, BASE)